# Testability Refactor Roadmap

This document consolidates the refactor proposals and remaining integration-only gaps needed to make startup/shutdown flows, secure storage, session restore, and keyboard shortcuts broadly testable. It builds on the patterns described in the round-trip testing, keyboard shortcuts, session persistence, and multi-window registry design docs to spell out the seams we should add for deterministic unit coverage and what still demands Electron-level integration runs.

## Refactors that unlock deterministic tests

- **Injectable secure-store adapters.** Make `createSecurePersistedStore` accept `(storage, crypto, availability)` so we can run Vitest without `window`/`electronAPI`, and matrix availability/legacy/plaintext/failure cases while keeping the IPC + `safeStorage` path as the production adapter.【F:src/ui/utils/secure-persisted-store.ts†L7-L118】【F:src/main/services/secure-storage.ts†L1-L98】
- **Pure persistence mappers with a thin IO shell.** Extract JSON serialize/deserialize from `SessionPersistenceService` so tests can restore/save all tab types and per-window metadata without real FS or `WebContentsView`, leaving file IO and view creation in the outer shell.【F:src/main/tab-manager/session-persistence-service.ts†L31-L218】【F:docs/design/10-session-persistence.md†L18-L115】
- **Testable window/view handles.** Wrap `WindowRegistry`/`TabManager` dependencies (`BrowserWindow`, `WebContentsView`) behind `WindowHandle`/`ViewHandle` interfaces to unit-test attach/detach/resize/close cleanup and tab ownership across windows without Electron, while preserving the multi-window registry contract.【F:docs/design/14-multi-window-tab-registry.md†L31-L147】【F:src/main/tab-manager.ts†L108-L157】
- **Pure shortcut pipeline before Electron binding.** Add a pure “input → action id” matcher (using the shared registry) and keep Electron handlers as thin adapters so chord matching, collision handling, and no-op behavior are unit-testable; focus timing (`sendFocusEvent`) remains an integration concern.【F:docs/design/08-keyboard-shortcuts.md†L101-L185】【F:src/shared/keyboard-shortcuts.ts†L1-L218】【F:src/main/tab-manager.ts†L196-L280】
- **Lifecycle/round-trip harness.** Provide a bootstrap helper that sequences load → operate → save → restart → restore with injected deps, mirroring the round-trip pattern to cover startup/shutdown regressions (LLM tabs, notes, file tabs, per-window active tab) in fast tests.【F:docs/design/06-round-trip-test-pattern.md†L1-L80】【F:docs/design/14-multi-window-tab-registry.md†L63-L80】
- **Injectable IPC transports.** Let preload/renderer bridge constructors accept a transport abstraction so store-sync and shortcut IPC listeners can be exercised without `ipcRenderer`/`ipcMain`, keeping the documented listener invariants intact.【F:docs/design/14-multi-window-tab-registry.md†L82-L147】【F:src/main/preload.ts†L200-L257】
- **Service dependency injection surfaces.** Keep `TabManager` services (LLM, navigation, persistence) fully parameterized so tests can stub throttling, aborts, and tab mutations while matching production behavior.【F:src/main/tab-manager.ts†L21-L105】【F:src/main/tab-manager.ts†L454-L476】

## Progress update

- Dependency-injection seams are now wired for headless tests:
  - `createSecurePersistedStore` accepts injected storage/availability/crypto adapters so tests can bypass `window`/`electronAPI` while still exercising encryption fallbacks.【F:src/ui/utils/secure-persisted-store.ts†L9-L127】
  - `createElectronAPI` builds the renderer bridge from an injectable IPC transport, letting tests supply stubbed `invoke/on` handlers without touching `ipcRenderer`.【F:src/main/preload.ts†L16-L173】
  - `TabManager` now accepts factories for the window registry, view creation, and its service dependencies (LLM, navigation, persistence, etc.) so tests can substitute throttling/mutation/failure behaviors directly.【F:src/main/tab-manager.ts†L21-L132】
  - Session persistence logic is factored into a pure mapper with injected IO so serialize/deserialize can be round-tripped in unit tests without touching the filesystem, and a lightweight harness exercises load → save → restore flows headlessly.【F:src/main/tab-manager/session-persistence-mapper.ts†L7-L54】【F:tests/main/session-persistence-harness.test.ts†L42-L118】
  - The round-trip harness now covers multi-window ownership and active-tab restoration using stub window handles and a stub session manager, keeping per-window state deterministic without Electron.【F:tests/main/session-persistence-harness.test.ts†L120-L215】
  - Platform-scoped shortcut chords (e.g., mac-only meta+[) are validated through the pure matcher to prevent cross-platform collisions before Electron binding.【F:tests/shared/keyboard-shortcuts.test.ts†L23-L79】
  - Persistence filters are asserted against mixed eligible/ineligible tabs to ensure only persistable entries survive save cycles.【F:tests/main/session-persistence-service.test.ts†L20-L96】
  - BrowserWindow/WebContentsView are wrapped in `WindowHandle`/`ViewHandle` adapters, letting TabManager attach/detach/resize/close views in tests without Electron while keeping the multi-window registry contract intact.【F:src/main/tab-manager/window-view-handles.ts†L4-L81】【F:tests/main/window-view-handles.test.ts†L63-L96】

## Integration-only gaps and what they require

- **OS/Electron shortcut interception (global/menu accelerators).** Electron or the OS can pre-consume chords before `before-input-event` fires. Only a real `BrowserWindow` driven by Electron/Playwright can reveal collisions; refactors alone cannot surface this to unit tests.【F:docs/design/08-keyboard-shortcuts.md†L101-L185】
- **SafeStorage and platform credential stores.** Availability/encrypt/decrypt behavior depends on the host OS (Keychain/Credential Manager/libsecret). Platform-specific integration runs are required to validate real native bindings; adapters only cover logic around them.【F:src/main/services/secure-storage.ts†L1-L98】
- **Real WebContents focus and navigation behavior.** Focus timing (`BrowserWindow.focus()` → `webContents.focus()` → renderer) and navigation failures are asynchronous and renderer-dependent; only Electron integration tests with actual WebContents can validate these flows.【F:docs/design/08-keyboard-shortcuts.md†L121-L185】
- **Filesystem permissions/locking for session files.** JSON save/restore under `app.getPath('userData')` can fail due to ACLs, locks, or disk limits; this needs integration tests writing to real (or permission-simulated) directories, beyond pure mappers.【F:docs/design/10-session-persistence.md†L18-L56】
- **Multi-window focus and per-window restore on real desktops.** Racey activation across multiple native windows (macOS Spaces, Windows virtual desktops) requires multi-window Electron scenarios to confirm tabs restore to the intended window or fall back correctly; interfaces alone can’t prove this.【F:docs/design/14-multi-window-tab-registry.md†L60-L152】
